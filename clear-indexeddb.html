<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clear IndexedDB Storage - Lifeline</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .alert {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 4px;
        }
        
        .alert strong {
            color: #856404;
        }
        
        .info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .databases {
            margin-bottom: 30px;
        }
        
        .db-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .db-name {
            font-weight: 500;
            color: #333;
        }
        
        .db-size {
            font-size: 12px;
            color: #666;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            width: 100%;
            margin-bottom: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }
        
        button.danger:hover {
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }
        
        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 4px;
            color: #155724;
            display: none;
        }
        
        .success.show {
            display: block;
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            font-weight: 500;
        }
        
        .footer {
            margin-top: 30px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóëÔ∏è Clear IndexedDB Storage</h1>
        <p class="subtitle">
            This tool will help you clear IndexedDB storage when you encounter "QuotaExceededError" or "indexed_db_went_bad" errors.
        </p>
        
        <div class="alert">
            <strong>‚ö†Ô∏è Warning:</strong> Clearing storage will remove all local data. Only use this if you're experiencing storage quota errors. Your account data on the server will not be affected.
        </div>
        
        <div id="databases" class="databases">
            <div class="info" id="loading">Loading database information...</div>
        </div>
        
        <div class="success" id="success">
            ‚úÖ Storage cleared successfully! You can now return to the app and refresh the page.
        </div>
        
        <button onclick="clearAllDatabases()">Clear All Lifeline Databases</button>
        <button class="danger" onclick="clearAllIndexedDB()">Clear ALL IndexedDB (Nuclear Option)</button>
        
        <div class="footer">
            <p>After clearing, close this page and return to the Lifeline app.</p>
            <p style="margin-top: 10px;">Refresh the app page to restart with clean storage.</p>
        </div>
    </div>

    <script>
        const lifelineDatabases = [
            'lifeline-alerts',
            'lifeline-local',
            'lifeline-local-68f7ae94d8e811421f98b5bc',
            '_pouch_lifeline-alerts',
            '_pouch_lifeline-local'
        ];

        async function detectDatabases() {
            const loadingDiv = document.getElementById('loading');
            const databasesDiv = document.getElementById('databases');
            
            const dbList = document.createElement('div');
            dbList.className = 'db-item';
            
            if (!window.indexedDB) {
                loadingDiv.innerHTML = '‚ùå IndexedDB is not supported in this browser.';
                return;
            }
            
            // Try to detect databases (limited by browser security)
            const databases = await indexedDB.databases();
            
            const lifelineDbs = databases.filter(db => {
                return lifelineDatabases.some(name => db.name.includes(name)) || 
                       db.name.startsWith('_pouch_') || 
                       db.name.includes('lifeline');
            });
            
            if (lifelineDbs.length === 0) {
                loadingDiv.innerHTML = '‚ÑπÔ∏è No Lifeline databases detected in IndexedDB.';
                return;
            }
            
            let html = '<div class="info">Detected Lifeline databases:</div>';
            lifelineDbs.forEach(db => {
                html += `
                    <div class="db-item">
                        <span class="db-name">${db.name}</span>
                        <span class="db-size">Version: ${db.version || 'N/A'}</span>
                    </div>
                `;
            });
            
            loadingDiv.innerHTML = html;
        }

        function clearAllDatabases() {
            if (!confirm('This will delete all Lifeline database data. Continue?')) {
                return;
            }
            
            let deleted = 0;
            
            lifelineDatabases.forEach(dbName => {
                try {
                    const req = indexedDB.deleteDatabase(dbName);
                    req.onsuccess = () => deleted++;
                    req.onerror = () => console.error(`Failed to delete ${dbName}:`, req.error);
                } catch (e) {
                    console.error(`Error deleting ${dbName}:`, e);
                }
            });
            
            // Also try to delete all _pouch_ databases
            if (indexedDB.databases) {
                indexedDB.databases().then(dbs => {
                    dbs.forEach(db => {
                        if (db.name.includes('lifeline') || db.name.startsWith('_pouch_')) {
                            try {
                                const req = indexedDB.deleteDatabase(db.name);
                                req.onsuccess = () => deleted++;
                            } catch (e) {
                                console.error(`Error deleting ${db.name}:`, e);
                            }
                        }
                    });
                });
            }
            
            const successDiv = document.getElementById('success');
            successDiv.classList.add('show');
            successDiv.innerHTML = `‚úÖ Clearing process started. ${deleted} databases will be deleted. Please wait a moment and refresh the app.`;
        }

        function clearAllIndexedDB() {
            if (!confirm('‚ö†Ô∏è NUCLEAR OPTION: This will delete ALL IndexedDB storage for this domain, including data from other apps. Continue?')) {
                return;
            }
            
            if (!indexedDB.databases) {
                alert('Your browser does not support the databases() API. Please use the "Clear All Lifeline Databases" option instead.');
                return;
            }
            
            indexedDB.databases().then(databases => {
                const deletePromises = databases.map(db => {
                    return new Promise((resolve, reject) => {
                        const req = indexedDB.deleteDatabase(db.name);
                        req.onsuccess = () => resolve(db.name);
                        req.onerror = () => reject(db.name);
                    });
                });
                
                Promise.all(deletePromises).then(() => {
                    const successDiv = document.getElementById('success');
                    successDiv.classList.add('show');
                    successDiv.innerHTML = `‚úÖ All IndexedDB storage cleared (${deletePromises.length} databases). Please wait a moment and refresh the app.`;
                }).catch(error => {
                    alert(`Some databases could not be deleted: ${error}`);
                });
            });
        }

        // Auto-detect databases on load
        detectDatabases();
    </script>
</body>
</html>
